name: Send callback (generate HMAC and dispatch)

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: 'Request ID'
        required: true
        default: 'r-0000000000-xxxx'
      response_text:
        description: 'Response text'
        required: false
        default: 'resultado de teste'
      needs_polling:
        description: 'needs_polling true or false'
        required: false
        default: 'true'

jobs:
  send-callback:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare payload (compact JSON)
        id: payload
        run: |
          REQ="${{ github.event.inputs.request_id }}"
          RESP="${{ github.event.inputs.response_text }}"
          PAYLOAD=$(jq -c -n --arg rid "$REQ" --arg resp_text "$RESP" '{request_id:$rid, response:{text:$resp_text}}')
          echo "payload_string=$PAYLOAD" >> $GITHUB_OUTPUT

      - name: Compute HMAC-SHA256
        id: sig
        env:
          SHARED_SECRET: ${{ secrets.SHARED_SECRET }}
        run: |
          PAYLOAD="${{ steps.payload.outputs.payload_string }}"
          SIG=$(printf '%s' "$PAYLOAD" | openssl dgst -sha256 -hmac "$SHARED_SECRET" -binary | xxd -p -c 256)
          echo "signature=sha256=$SIG" >> $GITHUB_OUTPUT

      - name: Dispatch to proxy workflow (repository_dispatch)
        env:
          REPO: DanielSalvi82/chat-gateway
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PAYLOAD="${{ steps.payload.outputs.payload_string }}"
          SIG="${{ steps.sig.outputs.signature }}"
          NEEDS="${{ github.event.inputs.needs_polling }}"
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO/dispatches \
            -d "{\"event_type\":\"fireworks-callback\",\"client_payload\":{\"payload_string\":${PAYLOAD@Q},\"signature\":\"${SIG}\",\"needs_polling\":\"${NEEDS}\"}}"
