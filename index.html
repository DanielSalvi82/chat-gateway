<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Gateway</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#128C7E">
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0b141a; color:#fff; }
    header { background:#128C7E; padding:10px; color:#fff; }
    .messages { height:70vh; overflow-y:auto; padding:10px; background:#111b21; }
    .bubble { padding:8px; margin:5px; border-radius:8px; max-width:70%; }
    .me { background:#005c4b; margin-left:auto; }
    .you { background:#202c33; margin-right:auto; }
    .input-bar { display:flex; padding:10px; background:#1f2c34; }
    .input-bar input { flex:1; padding:10px; border:none; border-radius:6px; }
    .input-bar button { margin-left:8px; padding:10px; background:#25d366; border:none; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <h3>Chat Gateway</h3>
    <div id="userDisplay">Usuário não definido</div>
  </header>

  <div>
    <input id="userName" placeholder="Digite seu nome/ID" />
    <button onclick="saveUser()">Salvar</button>
  </div>

  <div class="messages" id="messages"></div>

  <form class="input-bar" id="chatForm">
    <input id="messageInput" placeholder="Digite sua mensagem..." required />
    <button type="submit">Enviar</button>
  </form>

  <script>
    const WEBHOOK_URL = "https://hook.us2.make.com/zdh65fxga487rr7a4rlnwspoefard0o5"; // substitua pela URL do seu webhook Make
    let userId = localStorage.getItem('chat_user_id') || '';

    document.getElementById('userDisplay').textContent = userId ? `ID: ${userId}` : 'Usuário não definido';

    function saveUser() {
      userId = document.getElementById('userName').value.trim();
      localStorage.setItem('chat_user_id', userId);
      document.getElementById('userDisplay').textContent = `ID: ${userId}`;
    }

    document.getElementById('chatForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('messageInput').value;
      appendMessage('me', text);
      document.getElementById('messageInput').value = '';

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId || 'anon', message: text })
        });
        const data = await res.json();
        appendMessage('you', data.reply || 'Mensagem recebida.');
      } catch {
        appendMessage('you', 'Erro ao enviar.');
      }
    });

    function appendMessage(who, text) {
      const div = document.createElement('div');
      div.className = `bubble ${who}`;
      div.textContent = text;
      document.getElementById('messages').appendChild(div);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
  </script>
</body>

</html>
